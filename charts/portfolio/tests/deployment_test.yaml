suite: test deployment
templates:
  - deployment.yaml
tests:
  - it: should create a Deployment
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-portfolio

  - it: should set correct image
    set:
      image.repository: timmi6790/portfolio
      image.tag: v1.2.0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: timmi6790/portfolio:v1.2.0

  - it: should configure health checks correctly
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.path
          value: /api/health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /api/health
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /api/health

  - it: should configure security context
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: false
      - contains:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          content: ALL

  - it: should inject GITHUB_TOKEN from secret
    set:
      application.github.token: test-token
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                key: GITHUB_TOKEN
                name: RELEASE-NAME-portfolio

  - it: should mount required volumes
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: tmp
            mountPath: /tmp

  - it: should set resource limits
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 256Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 100m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 128Mi

  - it: should use custom resources when set
    set:
      resources.limits.cpu: 1000m
      resources.limits.memory: 512Mi
      resources.requests.cpu: 250m
      resources.requests.memory: 256Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 1000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 512Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 250m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 256Mi

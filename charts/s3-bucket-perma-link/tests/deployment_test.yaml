suite: test deployment
templates:
  - deployment.yaml
tests:
  - it: should create deployment
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-s3-bucket-perma-link

  - it: should mount S3 secret
    set:
      application:
        s3:
          secretName: s3-creds
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: s3-creds
                key: access_key
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: s3-creds
                key: secret_key

  - it: should set S3 configuration
    set:
      application:
        s3:
          host: "minio.local"
          region: "us-west-2"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: S3_HOST
            value: "minio.local"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: S3_REGION
            value: "us-west-2"
